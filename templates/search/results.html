{% extends 'base.html' %}

{% block title %}Search Courses - SkillStudio{% endblock %}

{% block sidebar %}
{% include 'components/sidebar.html' %}
{% endblock %}

{% block main_classes %}lg:ml-64 p-6 lg:p-8{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Search Header -->
    <div class="bg-dark-surface border border-dark-border rounded-lg p-6">
        <h1 class="text-2xl font-bold mb-4">Search Courses</h1>
        <div class="flex items-center space-x-3">
            <div class="flex-1 relative">
                <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <input type="text" id="search-input" placeholder="Search for courses, instructors, topics..." 
                    onkeyup="handleSearch(event)"
                    class="w-full pl-12 pr-4 py-3 bg-dark-bg border border-dark-border rounded-lg focus:ring-2 focus:ring-blue-500 text-lg">
            </div>
            <button onclick="performSearch()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors">
                Search
            </button>
        </div>
    </div>

    <!-- Filters Sidebar & Results -->
    <div class="grid lg:grid-cols-4 gap-6">
        <!-- Filters -->
        <div class="lg:col-span-1 space-y-4">
            <div class="bg-dark-surface border border-dark-border rounded-lg p-6">
                <h3 class="font-semibold mb-4">Filters</h3>
                
                <!-- Category -->
                <div class="mb-6">
                    <h4 class="text-sm font-medium mb-3">Category</h4>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" name="category" value="programming" class="w-4 h-4 text-blue-600 bg-dark-bg border-dark-border rounded">
                            <span class="ml-2 text-sm">Programming</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="category" value="design" class="w-4 h-4 text-blue-600 bg-dark-bg border-dark-border rounded">
                            <span class="ml-2 text-sm">Design</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="category" value="business" class="w-4 h-4 text-blue-600 bg-dark-bg border-dark-border rounded">
                            <span class="ml-2 text-sm">Business</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="category" value="marketing" class="w-4 h-4 text-blue-600 bg-dark-bg border-dark-border rounded">
                            <span class="ml-2 text-sm">Marketing</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="category" value="data-science" class="w-4 h-4 text-blue-600 bg-dark-bg border-dark-border rounded">
                            <span class="ml-2 text-sm">Data Science</span>
                        </label>
                    </div>
                </div>

                <!-- Level -->
                <div class="mb-6">
                    <h4 class="text-sm font-medium mb-3">Level</h4>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" name="level" value="beginner" class="w-4 h-4 text-blue-600 bg-dark-bg border-dark-border rounded">
                            <span class="ml-2 text-sm">Beginner</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="level" value="intermediate" class="w-4 h-4 text-blue-600 bg-dark-bg border-dark-border rounded">
                            <span class="ml-2 text-sm">Intermediate</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="level" value="advanced" class="w-4 h-4 text-blue-600 bg-dark-bg border-dark-border rounded">
                            <span class="ml-2 text-sm">Advanced</span>
                        </label>
                    </div>
                </div>

                <!-- Price -->
                <div class="mb-6">
                    <h4 class="text-sm font-medium mb-3">Price</h4>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="price" value="all" checked class="w-4 h-4 text-blue-600 bg-dark-bg border-dark-border">
                            <span class="ml-2 text-sm">All Courses</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="price" value="free" class="w-4 h-4 text-blue-600 bg-dark-bg border-dark-border">
                            <span class="ml-2 text-sm">Free</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="price" value="paid" class="w-4 h-4 text-blue-600 bg-dark-bg border-dark-border">
                            <span class="ml-2 text-sm">Paid</span>
                        </label>
                    </div>
                </div>

                <!-- Duration -->
                <div class="mb-6">
                    <h4 class="text-sm font-medium mb-3">Duration</h4>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" name="duration" value="0-2" class="w-4 h-4 text-blue-600 bg-dark-bg border-dark-border rounded">
                            <span class="ml-2 text-sm">0-2 hours</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="duration" value="2-5" class="w-4 h-4 text-blue-600 bg-dark-bg border-dark-border rounded">
                            <span class="ml-2 text-sm">2-5 hours</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="duration" value="5-10" class="w-4 h-4 text-blue-600 bg-dark-bg border-dark-border rounded">
                            <span class="ml-2 text-sm">5-10 hours</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="duration" value="10+" class="w-4 h-4 text-blue-600 bg-dark-bg border-dark-border rounded">
                            <span class="ml-2 text-sm">10+ hours</span>
                        </label>
                    </div>
                </div>

                <!-- Rating -->
                <div class="mb-6">
                    <h4 class="text-sm font-medium mb-3">Rating</h4>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" name="rating" value="4.5" class="w-4 h-4 text-blue-600 bg-dark-bg border-dark-border rounded">
                            <span class="ml-2 text-sm flex items-center">
                                <span>4.5+</span>
                                <svg class="w-4 h-4 ml-1 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                            </span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="rating" value="4" class="w-4 h-4 text-blue-600 bg-dark-bg border-dark-border rounded">
                            <span class="ml-2 text-sm flex items-center">
                                <span>4.0+</span>
                                <svg class="w-4 h-4 ml-1 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                            </span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="rating" value="3" class="w-4 h-4 text-blue-600 bg-dark-bg border-dark-border rounded">
                            <span class="ml-2 text-sm flex items-center">
                                <span>3.0+</span>
                                <svg class="w-4 h-4 ml-1 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Apply Filters -->
                <div class="flex flex-col space-y-2">
                    <button onclick="applyFilters()" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors">
                        Apply Filters
                    </button>
                    <button onclick="clearFilters()" class="w-full px-4 py-2 bg-dark-bg hover:bg-dark-border border border-dark-border rounded-lg font-medium transition-colors">
                        Clear All
                    </button>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="lg:col-span-3 space-y-4">
            <!-- Results Header -->
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-400"><span id="results-count">0</span> courses found</p>
                </div>
                <select id="sort-select" onchange="performSearch()" 
                    class="px-4 py-2 bg-dark-surface border border-dark-border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="relevance">Most Relevant</option>
                    <option value="popular">Most Popular</option>
                    <option value="rating">Highest Rated</option>
                    <option value="newest">Newest</option>
                    <option value="price-low">Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                </select>
            </div>

            <!-- Results Grid -->
            <div id="results-container" class="grid md:grid-cols-2 gap-6">
                <!-- Loading -->
                <div class="animate-pulse bg-dark-surface border border-dark-border rounded-lg h-64"></div>
                <div class="animate-pulse bg-dark-surface border border-dark-border rounded-lg h-64"></div>
                <div class="animate-pulse bg-dark-surface border border-dark-border rounded-lg h-64"></div>
                <div class="animate-pulse bg-dark-surface border border-dark-border rounded-lg h-64"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get search query from URL if present
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('q');
    if (query) {
        document.getElementById('search-input').value = query;
        performSearch();
    } else {
        performSearch(); // Load all courses initially
    }

    // Add change listeners to filters
    document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
        input.addEventListener('change', applyFilters);
    });
});

function handleSearch(event) {
    if (event.key === 'Enter') {
        performSearch();
    }
}

async function performSearch() {
    const container = document.getElementById('results-container');
    const query = document.getElementById('search-input').value;
    const sort = document.getElementById('sort-select').value;

    try {
        let url = '/api/courses/search/?';
        if (query) url += `q=${encodeURIComponent(query)}&`;
        if (sort) url += `sort=${sort}&`;

        // Add active filters
        const filters = getActiveFilters();
        Object.keys(filters).forEach(key => {
            if (filters[key].length > 0) {
                url += `${key}=${filters[key].join(',')}&`;
            }
        });

        const response = await apiRequest(url);
        const courses = response.results || response;

        document.getElementById('results-count').textContent = courses.length;

        if (courses.length > 0) {
            container.innerHTML = courses.map(course => renderCourseCard(course)).join('');
        } else {
            container.innerHTML = `
                <div class="col-span-2 text-center py-16 bg-dark-surface border border-dark-border rounded-lg">
                    <svg class="w-20 h-20 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <p class="text-gray-400 text-lg mb-2">No courses found</p>
                    <p class="text-gray-500 text-sm">Try adjusting your search or filters</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error searching courses:', error);
        container.innerHTML = '<div class="col-span-2 text-center py-16 text-red-400">Failed to load search results</div>';
    }
}

function getActiveFilters() {
    const filters = {
        category: [],
        level: [],
        duration: [],
        rating: []
    };

    document.querySelectorAll('input[name="category"]:checked').forEach(input => {
        filters.category.push(input.value);
    });

    document.querySelectorAll('input[name="level"]:checked').forEach(input => {
        filters.level.push(input.value);
    });

    document.querySelectorAll('input[name="duration"]:checked').forEach(input => {
        filters.duration.push(input.value);
    });

    document.querySelectorAll('input[name="rating"]:checked').forEach(input => {
        filters.rating.push(input.value);
    });

    const priceRadio = document.querySelector('input[name="price"]:checked');
    if (priceRadio && priceRadio.value !== 'all') {
        filters.price = [priceRadio.value];
    }

    return filters;
}

function renderCourseCard(course) {
    return `
        <a href="/courses/${course.slug}/" class="block bg-dark-surface border border-dark-border rounded-lg overflow-hidden hover:border-blue-500 transition-all hover:shadow-lg hover:shadow-blue-500/10">
            ${course.thumbnail ? `
                <img src="${course.thumbnail}" alt="${course.title}" class="w-full h-48 object-cover">
            ` : `
                <div class="w-full h-48 bg-gradient-to-br from-blue-900 to-purple-900 flex items-center justify-center">
                    <svg class="w-16 h-16 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                </div>
            `}
            <div class="p-6">
                <div class="flex items-center justify-between mb-3">
                    <span class="px-2.5 py-1 bg-blue-900/50 text-blue-400 text-xs font-semibold rounded">${course.category || 'General'}</span>
                    ${course.price ? `
                        <span class="text-lg font-bold text-blue-400">$${parseFloat(course.price).toFixed(2)}</span>
                    ` : `
                        <span class="px-2.5 py-1 bg-green-900/50 text-green-400 text-xs font-semibold rounded">FREE</span>
                    `}
                </div>
                <h3 class="font-semibold text-lg mb-2 line-clamp-2">${course.title}</h3>
                <p class="text-sm text-gray-400 mb-4 line-clamp-2">${course.short_description || ''}</p>
                <div class="flex items-center justify-between text-sm text-gray-500">
                    <span class="flex items-center space-x-1">
                        ${course.average_rating ? `
                            <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                            <span>${parseFloat(course.average_rating).toFixed(1)}</span>
                        ` : ''}
                    </span>
                    ${course.level ? `<span class="capitalize">${course.level}</span>` : ''}
                </div>
            </div>
        </a>
    `;
}

function applyFilters() {
    performSearch();
}

function clearFilters() {
    document.querySelectorAll('input[type="checkbox"]').forEach(input => {
        input.checked = false;
    });
    document.querySelector('input[name="price"][value="all"]').checked = true;
    performSearch();
}
</script>
{% endblock %}
