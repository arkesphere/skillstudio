{% extends 'base.html' %}

{% block title %}Courses - SkillStudio{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-4xl font-bold mb-2">Discover Courses</h1>
        <p class="text-gray-400">Learn new skills from expert instructors</p>
    </div>

    <!-- Filters & Search -->
    <div class="bg-dark-surface border border-dark-border rounded-lg p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- Search -->
            <div class="md:col-span-2">
                <input type="text" id="search-input" placeholder="Search courses..."
                    class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <!-- Category -->
            <div>
                <select id="category-filter" class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">All Categories</option>
                    <option value="programming">Programming</option>
                    <option value="design">Design</option>
                    <option value="business">Business</option>
                    <option value="marketing">Marketing</option>
                    <option value="data-science">Data Science</option>
                </select>
            </div>
            
            <!-- Level -->
            <div>
                <select id="level-filter" class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">All Levels</option>
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="advanced">Advanced</option>
                </select>
            </div>
        </div>
        
        <!-- Sort & Additional Filters -->
        <div class="flex flex-wrap items-center gap-4 mt-4">
            <select id="sort-filter" class="px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="-created_at">Newest First</option>
                <option value="title">Title A-Z</option>
                <option value="-enrollment_count">Most Popular</option>
                <option value="price">Price: Low to High</option>
                <option value="-price">Price: High to Low</option>
            </select>
            
            <label class="flex items-center space-x-2">
                <input type="checkbox" id="free-only" class="w-4 h-4 bg-dark-bg border-dark-border rounded text-blue-600">
                <span class="text-sm">Free Courses Only</span>
            </label>
        </div>
    </div>

    <!-- Course Grid -->
    <div id="courses-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        <!-- Loading skeletons -->
        <div class="animate-pulse bg-dark-surface border border-dark-border rounded-lg h-96"></div>
        <div class="animate-pulse bg-dark-surface border border-dark-border rounded-lg h-96"></div>
        <div class="animate-pulse bg-dark-surface border border-dark-border rounded-lg h-96"></div>
        <div class="animate-pulse bg-dark-surface border border-dark-border rounded-lg h-96"></div>
        <div class="animate-pulse bg-dark-surface border border-dark-border rounded-lg h-96"></div>
        <div class="animate-pulse bg-dark-surface border border-dark-border rounded-lg h-96"></div>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="flex justify-center items-center space-x-2"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentFilters = {};

document.addEventListener('DOMContentLoaded', function() {
    // Filter event listeners
    document.getElementById('search-input').addEventListener('input', debounce(applyFilters, 500));
    document.getElementById('category-filter').addEventListener('change', applyFilters);
    document.getElementById('level-filter').addEventListener('change', applyFilters);
    document.getElementById('sort-filter').addEventListener('change', applyFilters);
    document.getElementById('free-only').addEventListener('change', applyFilters);
    
    // Initial load
    loadCourses();
});

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function applyFilters() {
    currentPage = 1;
    currentFilters = {
        search: document.getElementById('search-input').value,
        category: document.getElementById('category-filter').value,
        level: document.getElementById('level-filter').value,
        ordering: document.getElementById('sort-filter').value,
        free_only: document.getElementById('free-only').checked
    };
    loadCourses();
}

async function loadCourses(page = 1) {
    const container = document.getElementById('courses-container');
    container.innerHTML = '<div class="col-span-3 flex justify-center py-12"><div class="animate-spin h-12 w-12 border-4 border-blue-500 border-t-transparent rounded-full"></div></div>';
    
    try {
        // Build query params
        const params = new URLSearchParams({
            page: page,
            status: 'published',
            ...currentFilters
        });
        
        // Remove empty filters
        for (let [key, value] of [...params.entries()]) {
            if (!value || value === 'false') params.delete(key);
        }
        
        const response = await fetch(`/api/courses/?${params.toString()}`);
        const data = await response.json();
        
        if (data.results && data.results.length > 0) {
            container.innerHTML = data.results.map(course => `
                <a href="/courses/${course.slug || course.id}/" class="block bg-dark-surface border border-dark-border rounded-lg overflow-hidden hover:border-blue-500 transition-all hover:shadow-lg hover:shadow-blue-500/10">
                    <div class="h-48 bg-gradient-to-br from-blue-500 to-purple-600 relative">
                        ${course.price === 0 || course.price === '0.00' ? 
                            '<span class="absolute top-3 right-3 bg-green-600 text-white text-xs px-3 py-1 rounded-full font-semibold">FREE</span>' : 
                            `<span class="absolute top-3 right-3 bg-blue-600 text-white text-xs px-3 py-1 rounded-full font-semibold">$${course.price}</span>`
                        }
                    </div>
                    <div class="p-4">
                        <div class="flex items-center space-x-2 mb-2">
                            ${course.category ? `<span class="text-xs px-2 py-1 bg-purple-900/50 text-purple-300 rounded">${course.category}</span>` : ''}
                            ${course.level ? `<span class="text-xs px-2 py-1 bg-blue-900/50 text-blue-300 rounded capitalize">${course.level}</span>` : ''}
                        </div>
                        <h3 class="font-semibold mb-2 line-clamp-2">${course.title}</h3>
                        <p class="text-sm text-gray-400 mb-3 line-clamp-2">${course.description || 'No description available'}</p>
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center space-x-1 text-gray-400">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                <span>${course.instructor_name || 'Instructor'}</span>
                            </div>
                            <div class="flex items-center space-x-1 text-gray-400">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                                <span>${course.rating || '0.0'} (${course.reviews_count || 0})</span>
                            </div>
                        </div>
                        ${course.enrollment_count ? `<p class="text-xs text-gray-500 mt-2">${course.enrollment_count} students enrolled</p>` : ''}
                    </div>
                </a>
            `).join('');
            
            // Render pagination
            renderPagination(data, page);
        } else {
            container.innerHTML = `
                <div class="col-span-3 text-center py-16 bg-dark-surface border border-dark-border rounded-lg">
                    <svg class="w-20 h-20 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p class="text-gray-400 text-lg mb-2">No courses found</p>
                    <p class="text-gray-500 text-sm">Try adjusting your filters</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading courses:', error);
        container.innerHTML = `
            <div class="col-span-3 text-center py-16 bg-dark-surface border border-dark-border rounded-lg">
                <p class="text-red-400">Failed to load courses. Please try again.</p>
            </div>
        `;
    }
}

function renderPagination(data, currentPage) {
    const container = document.getElementById('pagination');
    const totalPages = Math.ceil(data.count / 12); // Assuming 12 items per page
    
    if (totalPages <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // Previous button
    if (currentPage > 1) {
        html += `<button onclick="loadCourses(${currentPage - 1})" class="px-4 py-2 bg-dark-surface border border-dark-border rounded-lg hover:border-blue-500 transition-colors">Previous</button>`;
    }
    
    // Page numbers
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        html += `<button onclick="loadCourses(${i})" class="px-4 py-2 rounded-lg transition-colors ${i === currentPage ? 'bg-blue-600 text-white' : 'bg-dark-surface border border-dark-border hover:border-blue-500'}">${i}</button>`;
    }
    
    // Next button
    if (currentPage < totalPages) {
        html += `<button onclick="loadCourses(${currentPage + 1})" class="px-4 py-2 bg-dark-surface border border-dark-border rounded-lg hover:border-blue-500 transition-colors">Next</button>`;
    }
    
    container.innerHTML = html;
}
</script>
{% endblock %}
