{% extends 'base.html' %}

{% block title %}Assessment Results - SkillStudio{% endblock %}

{% block sidebar %}
{% include 'components/sidebar.html' %}
{% endblock %}

{% block main_classes %}lg:ml-64 p-6 lg:p-8{% endblock %}

{% block content %}
<div id="results-container">
    <!-- Loading State -->
    <div class="flex justify-center items-center py-20">
        <div class="animate-spin h-16 w-16 border-4 border-blue-500 border-t-transparent rounded-full"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let assessmentId;
let attemptId;

document.addEventListener('DOMContentLoaded', function() {
    // Get IDs from URL
    const pathParts = window.location.pathname.split('/');
    assessmentId = pathParts[2];
    attemptId = pathParts[4];
    
    loadResults();
});

async function loadResults() {
    const container = document.getElementById('results-container');

    try {
        const attempt = await apiRequest(`/assessments/attempts/${attemptId}/`);
        const assessment = attempt.assessment;
        
        // Load detailed results with correct/incorrect answers
        const detailedResults = await apiRequest(`/assessments/attempts/${attemptId}/results/`);

        const passed = attempt.score >= (assessment.passing_score || 0);
        const completedAt = new Date(attempt.completed_at);

        container.innerHTML = `
            <!-- Results Header -->
            <div class="bg-gradient-to-r ${passed ? 'from-green-900/50 to-emerald-900/50 border-green-500/30' : 'from-red-900/50 to-orange-900/50 border-red-500/30'} border rounded-lg p-8 mb-8">
                <div class="text-center">
                    <div class="w-24 h-24 mx-auto mb-6 rounded-full ${passed ? 'bg-green-600' : 'bg-red-600'} flex items-center justify-center">
                        ${passed ? `
                            <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        ` : `
                            <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        `}
                    </div>
                    
                    <h1 class="text-4xl font-bold mb-2">${passed ? 'Congratulations!' : 'Not Passed'}</h1>
                    <p class="text-xl text-gray-300 mb-6">${assessment.title}</p>
                    
                    <div class="inline-block px-8 py-4 bg-dark-surface border border-dark-border rounded-lg">
                        <p class="text-sm text-gray-400 mb-1">Your Score</p>
                        <p class="text-5xl font-bold ${passed ? 'text-green-400' : 'text-red-400'}">${attempt.score}%</p>
                    </div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid md:grid-cols-4 gap-6 mb-8">
                <div class="bg-dark-surface border border-dark-border rounded-lg p-6">
                    <div class="flex items-center space-x-3 mb-2">
                        <div class="w-10 h-10 bg-blue-900/50 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-green-400">${detailedResults.correct_count || 0}</p>
                            <p class="text-sm text-gray-400">Correct</p>
                        </div>
                    </div>
                </div>

                <div class="bg-dark-surface border border-dark-border rounded-lg p-6">
                    <div class="flex items-center space-x-3 mb-2">
                        <div class="w-10 h-10 bg-red-900/50 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-red-400">${detailedResults.incorrect_count || 0}</p>
                            <p class="text-sm text-gray-400">Incorrect</p>
                        </div>
                    </div>
                </div>

                <div class="bg-dark-surface border border-dark-border rounded-lg p-6">
                    <div class="flex items-center space-x-3 mb-2">
                        <div class="w-10 h-10 bg-gray-900/50 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-2xl font-bold">${assessment.total_questions || 0}</p>
                            <p class="text-sm text-gray-400">Total Questions</p>
                        </div>
                    </div>
                </div>

                <div class="bg-dark-surface border border-dark-border rounded-lg p-6">
                    <div class="flex items-center space-x-3 mb-2">
                        <div class="w-10 h-10 bg-purple-900/50 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-2xl font-bold">${formatDuration(attempt.time_taken)}</p>
                            <p class="text-sm text-gray-400">Time Taken</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Breakdown -->
            ${assessment.passing_score ? `
                <div class="bg-dark-surface border border-dark-border rounded-lg p-6 mb-8">
                    <h2 class="text-xl font-semibold mb-4">Performance Analysis</h2>
                    <div class="space-y-4">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-400">Your Score</span>
                                <span class="font-semibold">${attempt.score}%</span>
                            </div>
                            <div class="w-full bg-dark-bg rounded-full h-3">
                                <div class="bg-gradient-to-r ${passed ? 'from-green-500 to-emerald-600' : 'from-red-500 to-orange-600'} h-3 rounded-full transition-all" style="width: ${attempt.score}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-400">Passing Score</span>
                                <span class="font-semibold">${assessment.passing_score}%</span>
                            </div>
                            <div class="w-full bg-dark-bg rounded-full h-3">
                                <div class="bg-blue-600 h-3 rounded-full" style="width: ${assessment.passing_score}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            ` : ''}

            <!-- Question Review -->
            ${detailedResults.questions ? `
                <div class="bg-dark-surface border border-dark-border rounded-lg p-6 mb-8">
                    <h2 class="text-xl font-semibold mb-6">Question Review</h2>
                    <div class="space-y-6">
                        ${detailedResults.questions.map((q, index) => renderQuestionReview(q, index)).join('')}
                    </div>
                </div>
            ` : ''}

            <!-- Actions -->
            <div class="flex flex-wrap gap-4 justify-center">
                <a href="/assessments/" class="px-6 py-3 bg-dark-hover hover:bg-dark-border border border-dark-border text-white rounded-lg font-semibold transition-colors">
                    Back to Assessments
                </a>
                ${!passed && (assessment.max_attempts > attempt.attempt_number) ? `
                    <a href="/assessments/${assessmentId}/attempt/" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors">
                        Retake Assessment
                    </a>
                ` : ''}
                ${assessment.certificate_enabled && passed ? `
                    <button onclick="downloadCertificate()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-colors flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>Download Certificate</span>
                    </button>
                ` : ''}
            </div>
        `;
    } catch (error) {
        console.error('Error loading results:', error);
        container.innerHTML = `
            <div class="bg-dark-surface border border-dark-border rounded-lg p-12 text-center">
                <svg class="w-20 h-20 mx-auto mb-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <p class="text-xl font-semibold mb-2">Error Loading Results</p>
                <p class="text-gray-400 mb-6">Failed to load assessment results</p>
                <a href="/assessments/" class="inline-block px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors">
                    Back to Assessments
                </a>
            </div>
        `;
    }
}

function renderQuestionReview(question, index) {
    const isCorrect = question.is_correct;
    const userAnswer = question.user_answer;
    const correctAnswer = question.correct_answer;

    return `
        <div class="border-l-4 ${isCorrect ? 'border-green-500' : 'border-red-500'} pl-4">
            <div class="flex items-start justify-between mb-3">
                <h3 class="font-semibold">Question ${index + 1}</h3>
                <span class="px-3 py-1 text-xs rounded-full ${isCorrect ? 'bg-green-900/50 text-green-400' : 'bg-red-900/50 text-red-400'}">
                    ${isCorrect ? 'Correct' : 'Incorrect'}
                </span>
            </div>
            
            <p class="text-gray-300 mb-4">${question.question_text}</p>
            
            <div class="space-y-2 text-sm">
                <div>
                    <span class="text-gray-400">Your Answer:</span>
                    <span class="ml-2 ${isCorrect ? 'text-green-400' : 'text-red-400'}">${userAnswer || 'Not answered'}</span>
                </div>
                ${!isCorrect && correctAnswer ? `
                    <div>
                        <span class="text-gray-400">Correct Answer:</span>
                        <span class="ml-2 text-green-400">${correctAnswer}</span>
                    </div>
                ` : ''}
                ${question.explanation ? `
                    <div class="mt-3 p-3 bg-blue-900/20 border border-blue-500/30 rounded">
                        <p class="text-xs text-gray-400 mb-1">Explanation:</p>
                        <p class="text-sm text-gray-300">${question.explanation}</p>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

function formatDuration(seconds) {
    if (!seconds) return 'N/A';
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${minutes}m ${secs}s`;
}

async function downloadCertificate() {
    try {
        const response = await apiRequest(`/assessments/attempts/${attemptId}/certificate/`);
        if (response.certificate_url) {
            window.open(response.certificate_url, '_blank');
        } else {
            showAlert('Certificate is being generated. Please try again in a moment.', 'info');
        }
    } catch (error) {
        console.error('Error downloading certificate:', error);
        showAlert('Failed to download certificate', 'error');
    }
}
</script>
{% endblock %}
